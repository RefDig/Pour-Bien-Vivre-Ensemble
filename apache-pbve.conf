# Configuration Apache pour Pour Bien Vivre Ensemble
# À placer dans /etc/apache2/sites-available/pbve.conf ou dans un fichier .htaccess

<VirtualHost *:80>
    ServerName pourbienvivreensemble.fr
    ServerAlias www.pourbienvivreensemble.fr

    # Logs
    ErrorLog ${APACHE_LOG_DIR}/pbve-error.log
    CustomLog ${APACHE_LOG_DIR}/pbve-access.log combined

    # Activer les modules proxy
    # a2enmod proxy proxy_http proxy_wstunnel rewrite headers

    # Proxy vers Node.js (port 3000)
    ProxyPreserveHost On
    ProxyPass / http://localhost:3000/
    ProxyPassReverse / http://localhost:3000/

    # WebSocket support
    RewriteEngine On
    RewriteCond %{HTTP:Upgrade} =websocket [NC]
    RewriteRule /(.*)           ws://localhost:3000/$1 [P,L]
    RewriteCond %{HTTP:Upgrade} !=websocket [NC]
    RewriteRule /(.*)           http://localhost:3000/$1 [P,L]

    # Headers de sécurité
    Header always set X-Frame-Options "SAMEORIGIN"
    Header always set X-Content-Type-Options "nosniff"
    Header always set X-XSS-Protection "1; mode=block"

    # Taille maximale des uploads
    LimitRequestBody 52428800
</VirtualHost>

# Configuration HTTPS (après avoir installé Certbot)
# Décommentez après avoir exécuté : certbot --apache -d pourbienvivreensemble.fr -d www.pourbienvivreensemble.fr
#
# <VirtualHost *:443>
#     ServerName pourbienvivreensemble.fr
#     ServerAlias www.pourbienvivreensemble.fr
#
#     SSLEngine on
#     SSLCertificateFile /etc/letsencrypt/live/pourbienvivreensemble.fr/fullchain.pem
#     SSLCertificateKeyFile /etc/letsencrypt/live/pourbienvivreensemble.fr/privkey.pem
#
#     ProxyPreserveHost On
#     ProxyPass / http://localhost:3000/
#     ProxyPassReverse / http://localhost:3000/
#
#     # WebSocket support
#     RewriteEngine On
#     RewriteCond %{HTTP:Upgrade} =websocket [NC]
#     RewriteRule /(.*)           ws://localhost:3000/$1 [P,L]
#     RewriteCond %{HTTP:Upgrade} !=websocket [NC]
#     RewriteRule /(.*)           http://localhost:3000/$1 [P,L]
# </VirtualHost>
